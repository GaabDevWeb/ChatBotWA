const puppeteer = require('puppeteer');
const logger = require('../logger');

class RastreamentoService {
    constructor() {
        this.baseUrl = 'https://ssw.inf.br/2/rastreamento';
        this.timeout = 30000; // 30 segundos
        this.retryAttempts = 2;
    }

    /**
     * Consulta rastreamento de mercadoria usando web scraping funcional
     * @param {string} cnpj - CNPJ (14 d√≠gitos)
     * @param {string} nf - N√∫mero da Nota Fiscal
     * @returns {Promise<Object>} Dados do rastreamento
     */
    async consultar(cnpj, nf) {
        let browser = null;
        
        try {
            logger.info('üöÄ Iniciando web scraping SSW...', { 
                cnpj: cnpj.substring(0, 8) + '****',
                nf
            });
            
            // Lan√ßa o navegador
            browser = await puppeteer.launch({
                headless: true, // Mudado para true em produ√ß√£o
                defaultViewport: null,
                args: [
                    '--no-sandbox',
                    '--disable-setuid-sandbox',
                    '--disable-dev-shm-usage',
                    '--disable-accelerated-2d-canvas',
                    '--no-first-run',
                    '--no-zygote',
                    '--disable-gpu'
                ]
            });
            
            // Cria nova p√°gina
            const page = await browser.newPage();
            
            logger.info('üìÑ Navegando para a URL da SSW...');
            
            // Navega para a URL
            await page.goto(this.baseUrl, {
                waitUntil: 'networkidle2',
                timeout: this.timeout
            });
            
            logger.info('‚úÖ P√°gina carregada com sucesso!');
            
            // Aguarda os campos estarem dispon√≠veis
            await page.waitForSelector('#cnpj', { timeout: 10000 });
            await page.waitForSelector('#NR', { timeout: 10000 });
            
            logger.info('üìù Preenchendo campos...');
            
            // Limpa e preenche o campo CNPJ
            await page.click('#cnpj');
            await page.keyboard.down('Control');
            await page.keyboard.press('KeyA');
            await page.keyboard.up('Control');
            await page.type('#cnpj', cnpj);
            
            // Limpa e preenche o campo NR (N√∫mero da Nota)
            await page.click('#NR');
            await page.keyboard.down('Control');
            await page.keyboard.press('KeyA');
            await page.keyboard.up('Control');
            await page.type('#NR', nf);
            
            logger.info('‚úÖ Campos preenchidos com sucesso!');
            
            // Aguarda o bot√£o rastrear estar dispon√≠vel
            await page.waitForSelector('#btn_rastrear', { timeout: 10000 });
            
            // Clica no bot√£o rastrear
            logger.info('üñ±Ô∏è Clicando no bot√£o rastrear...');
            await page.click('#btn_rastrear');
            
            // Aguarda a navega√ß√£o para a p√°gina de resultado
            logger.info('‚è≥ Aguardando redirecionamento para p√°gina de resultado...');
            
            try {
                await page.waitForNavigation({ 
                    waitUntil: 'domcontentloaded',
                    timeout: 15000
                });
            } catch (navError) {
                logger.info('‚ö†Ô∏è Timeout na navega√ß√£o, verificando se a p√°gina mudou...');
                await page.waitForTimeout(2000);
            }
            
            // Verifica se chegou na p√°gina de resultado
            const currentUrl = page.url();
            logger.info(`üìç URL atual: ${currentUrl}`);
            
            if (currentUrl.includes('resultSSW')) {
                logger.info('‚úÖ Redirecionado para p√°gina de resultado com sucesso!');
                
                // Aguardar especificamente pela tabela de resultados
                try {
                    await page.waitForSelector('table[style*="border:1px solid #e9e9e9"]', { timeout: 10000 });
                    logger.info('‚úÖ Tabela de resultados encontrada!');
                } catch (tableError) {
                    logger.info('‚ö†Ô∏è Tabela n√£o encontrada, tentando capturar dados mesmo assim...');
                }
                
                // Captura dados espec√≠ficos baseados na estrutura HTML real
                logger.info('üîç Capturando dados de rastreamento...');
                
                const rastreamentoInfo = await this.extrairDadosRastreamento(page);
                
                logger.info('üì¶ Dados capturados com sucesso', {
                    totalResultados: rastreamentoInfo.totalResultados
                });
                
                return this.formatarResposta(rastreamentoInfo);
                
            } else {
                logger.warn('‚ö†Ô∏è N√£o foi redirecionado para a p√°gina de resultado esperada.');
                
                // Captura poss√≠veis mensagens de erro
                const errorInfo = await page.evaluate(() => {
                    const body = document.body.textContent;
                    return {
                        url: window.location.href,
                        content: body.trim()
                    };
                });
                
                return {
                    sucesso: false,
                    erro: 'N√£o foi poss√≠vel acessar os dados de rastreamento',
                    detalhes: errorInfo.content.substring(0, 200)
                };
            }
            
        } catch (error) {
            logger.error('‚ùå Erro durante o web scraping:', error);
            return {
                sucesso: false,
                erro: 'Erro interno no sistema de rastreamento',
                detalhes: error.message
            };
        } finally {
            if (browser) {
                await browser.close();
                logger.info('üîí Navegador fechado.');
            }
        }
    }

    /**
     * Extrai dados de rastreamento da p√°gina de resultado
     * @param {Object} page - P√°gina do Puppeteer
     * @returns {Promise<Object>} Dados extra√≠dos
     */
    async extrairDadosRastreamento(page) {
        return await page.evaluate(() => {
            const resultados = [];
            
            // Capturar informa√ß√µes do remetente
            const remetenteElement = document.querySelector('span.rastreamento');
            const cnpjElement = document.querySelector('span.tdb[style*="color:blue"]');
            
            const remetente = remetenteElement ? remetenteElement.textContent.trim() : '';
            const cnpjRemetente = cnpjElement ? cnpjElement.textContent.trim() : '';
            
            // Buscar a tabela principal de resultados (com borda)
            const tabelaResultados = document.querySelector('table[style*="border:1px solid #e9e9e9"]');
            
            if (tabelaResultados) {
                // Buscar todas as linhas de dados (com background branco e cursor pointer)
                const linhasDados = tabelaResultados.querySelectorAll('tr[style*="background-color:#FFFFFF"][style*="cursor:pointer"]');
                
                linhasDados.forEach((linha, index) => {
                    const celulas = linha.querySelectorAll('td');
                    
                    if (celulas.length >= 3) {
                        // Primeira coluna: N√∫mero Fiscal/Coleta e N√∫mero do Pedido
                        const celulaFiscal = celulas[0];
                        const numeroFiscal = celulaFiscal.textContent.trim();
                        
                        // Segunda coluna: Unidade e Data/Hora
                        const celulaLocal = celulas[1];
                        const unidadeDataHora = celulaLocal.textContent.trim();
                        
                        // Terceira coluna: Situa√ß√£o completa
                        const celulaSituacao = celulas[2];
                        const situacaoCompleta = celulaSituacao.textContent.trim();
                        
                        // Extrair t√≠tulo da situa√ß√£o (em negrito)
                        const tituloSituacao = celulaSituacao.querySelector('p.titulo');
                        const titulo = tituloSituacao ? tituloSituacao.textContent.trim() : '';
                        
                        // Extrair detalhes da situa√ß√£o
                        const detalhesElements = celulaSituacao.querySelectorAll('p.tdb');
                        const detalhes = Array.from(detalhesElements).map(el => el.textContent.trim()).join(' ');
                        
                        resultados.push({
                            indice: index + 1,
                            numeroFiscal: numeroFiscal,
                            unidadeDataHora: unidadeDataHora,
                            tituloSituacao: titulo,
                            detalhesSituacao: detalhes,
                            situacaoCompleta: situacaoCompleta
                        });
                    }
                });
            }
            
            return {
                remetente: remetente,
                cnpjRemetente: cnpjRemetente,
                totalResultados: resultados.length,
                resultados: resultados
            };
        });
    }

    /**
     * Formata a resposta para o MenuInterceptor
     * @param {Object} rastreamentoInfo - Dados brutos do rastreamento
     * @returns {Object} Resposta formatada
     */
    formatarResposta(rastreamentoInfo) {
        if (!rastreamentoInfo || rastreamentoInfo.totalResultados === 0) {
            return {
                sucesso: false,
                erro: 'Nenhum resultado de rastreamento encontrado',
                detalhes: 'Verifique se o CNPJ e n√∫mero da nota fiscal est√£o corretos'
            };
        }

        let mensagem = `üì¶ *RASTREAMENTO DE MERCADORIA*\n\n`;
        mensagem += `üìã *Remetente:* ${rastreamentoInfo.remetente}\n`;
        mensagem += `üè¢ *CNPJ:* ${rastreamentoInfo.cnpjRemetente}\n`;
        mensagem += `üìä *Total de registros:* ${rastreamentoInfo.totalResultados}\n\n`;

        rastreamentoInfo.resultados.forEach((resultado, index) => {
            mensagem += `üî∏ *REGISTRO ${index + 1}*\n`;
            mensagem += `üìÑ *N√∫mero Fiscal:* ${resultado.numeroFiscal}\n`;
            mensagem += `üìç *Local/Data:* ${resultado.unidadeDataHora}\n`;
            mensagem += `üéØ *Status:* ${resultado.tituloSituacao}\n`;
            if (resultado.detalhesSituacao) {
                mensagem += `üìù *Detalhes:* ${resultado.detalhesSituacao}\n`;
            }
            mensagem += `\n`;
        });

        mensagem += `‚úÖ *Consulta realizada com sucesso!*`;

        return {
            sucesso: true,
            mensagem: mensagem,
            dados: rastreamentoInfo
        };
    }

    /**
     * Valida os dados de entrada
     * @param {string} cnpj - CNPJ
     * @param {string} nf - N√∫mero da nota fiscal
     * @returns {Object} Resultado da valida√ß√£o
     */
    validarDados(cnpj, nf) {
        const errors = [];

        // Valida√ß√£o CNPJ
        if (!cnpj || cnpj.length < 11) {
            errors.push('CNPJ deve ter pelo menos 11 d√≠gitos');
        }

        // Valida√ß√£o NF
        if (!nf || nf.trim().length === 0) {
            errors.push('N√∫mero da nota fiscal √© obrigat√≥rio');
        }

        return {
            valido: errors.length === 0,
            erros: errors
        };
    }

    /**
     * M√©todo p√∫blico com valida√ß√£o
     * @param {string} cnpj - CNPJ
     * @param {string} nf - N√∫mero da nota fiscal
     * @returns {Promise<Object>} Resultado da consulta
     */
    async consultarComValidacao(cnpj, nf) {
        const validacao = this.validarDados(cnpj, nf);
        
        if (!validacao.valido) {
            return {
                sucesso: false,
                erro: 'Dados inv√°lidos',
                detalhes: validacao.erros.join(', ')
            };
        }

        return await this.consultar(cnpj, nf);
    }
}

module.exports = new RastreamentoService();